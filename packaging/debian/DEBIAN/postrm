#!/bin/bash
set -e

AUDYN_USER="audyn"
AUDYN_GROUP="audyn"

case "$1" in
    purge)
        # Remove user and group (only on purge, not remove)
        if getent passwd "$AUDYN_USER" > /dev/null 2>&1; then
            userdel "$AUDYN_USER" 2>/dev/null || true
            echo "Removed system user: $AUDYN_USER"
        fi

        if getent group "$AUDYN_GROUP" > /dev/null 2>&1; then
            groupdel "$AUDYN_GROUP" 2>/dev/null || true
            echo "Removed system group: $AUDYN_GROUP"
        fi

        # Remove configuration (only on purge)
        rm -rf /etc/audyn

        # Remove log directory
        rm -rf /var/log/audyn

        # Remove Python venv and any remaining files in /opt/audyn
        rm -rf /opt/audyn

        # Note: /var/lib/audyn/archive is NOT removed to preserve recordings
        echo ""
        echo "Note: Archive directory /var/lib/audyn/archive was preserved."
        echo "Remove manually if no longer needed."
        echo ""
        ;;

    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        ;;

    *)
        echo "postrm called with unknown argument: $1" >&2
        exit 1
        ;;
esac

exit 0
